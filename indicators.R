####
#
#  CODE USED TO TO PRODUCE INDIVIDUAL INDICATOR DATASETS AND RISK COMPONENT SHEETS
#
####
runtime <- Sys.time()
#--------------------LOAD PACKAGES-----------------------------------------
# packagesAll <- c("cowplot", "lubridate", "rvest", "viridis", "countrycode", 
#                  "clipr", "awalker89", "openxlsx", "dplyr", "readxl", "gsheet",
#                  "zoo", "wppExplorer", "haven", "EnvStats", "jsonlite", 
#                  "matrixStats", "ggalt", "raster", "sf", "mapview", "maptools", 
#                  "ggthemes", "tidyverse", "sjmsc", "googledrive", "rgdal")

packages <- c("curl", "dplyr", "EnvStats", "stats", "countrycode", "ggplot2", 
              "jsonlite","lubridate", "matrixStats", "readr", "readxl", "rvest",   
              "sjmisc", "stringr", "tidyr", "xml2", "zoo")
invisible(lapply(packages, require, quietly = TRUE, character.only = TRUE))

# # install.packages("sparklyr")
# SparkR::sparkR.session()
# library(sparklyr)
# sc <- spark_connect(method = "databricks")


# github <- "https://raw.githubusercontent.com/ljonestz/compoundriskdata/master/"
github <- "https://raw.githubusercontent.com/bennotkin/compoundriskdata/master/"

{
  #--------------------FUNCTION TO CALCULATE NORMALISED SCORES-----------------
  # Function to normalise with upper and lower bounds (when low score = high vulnerability)
  normfuncneg <- function(df, upperrisk, lowerrisk, col1) {
    # Create new column col_name as sum of col1 and col2
    df[[paste0(col1, "_norm")]] <- ifelse(df[[col1]] <= upperrisk, 10,
                                          ifelse(df[[col1]] >= lowerrisk, 0,
                                                 ifelse(df[[col1]] > upperrisk & df[[col1]] < lowerrisk, 10 - (upperrisk - df[[col1]]) / 
                                                          (upperrisk - lowerrisk) * 10, NA)
                                          )
    )
    df
  }
  
  # Function to normalise with upper and lower bounds (when high score = high vulnerability)
  normfuncpos <- function(df, upperrisk, lowerrisk, col1) {
    # Create new column col_name as sum of col1 and col2
    df[[paste0(col1, "_norm")]] <- ifelse(df[[col1]] >= upperrisk, 10,
                                          ifelse(df[[col1]] <= lowerrisk, 0,
                                                 ifelse(df[[col1]] < upperrisk & df[[col1]] > lowerrisk, 10 - (upperrisk - df[[col1]]) / 
                                                          (upperrisk - lowerrisk) * 10, NA)
                                          )
    )
    df
  }
  lap <- Sys.time() - runtime
  print(paste("Setup:", lap, units(lap)))
  lapStart <- Sys.time()
  #
  ##
  ### ********************************************************************************************
  ####    CREATE ACAPS SHEET USING A RANGE OF SOURCE INDICATORS ----
  ### ********************************************************************************************
  ##
  #
  
  #--------------------—LOAD ACAPS realtime database-------------------------------------------
  # Load website
  acaps <- read_html("https://www.acaps.org/countries")
  # ERROR: running this in Databricks I get `Error in open.connection(x, "rb") : 
  # gnutls_handshake() failed: Error in the pull function.`
  
  # Select relevant columns from the site all merged into a single string
  country <- acaps %>%
    html_nodes(".severity__country__label, .severity__country__crisis__label, .severity__country__crisis__value") %>%
    html_text()
  
  # Find country labels in the string (select 2nd lag behind a numberic variable if the given item is a character)
  countryisolate <- suppressWarnings(ifelse(!is.na(as.numeric(as.character(country))) & lag(is.na(as.numeric(as.character(country))), 2),
                                            lag(country, 2),
                                            NA
  ))
  
  # For all variables that have a country label, change to iso categories
  country[which(!is.na(countryisolate)) - 2] <- countrycode(country[which(!is.na(countryisolate)) - 2],
                                                            origin = "country.name",
                                                            destination = "iso3c",
                                                            nomatch = NULL
  )
  
  # Collect list of all world countries
  world <- map_data("world")
  world <- world %>%
    dplyr::rename(Country = region) %>%
    dplyr::mutate(Country = suppressWarnings(countrycode(Country,
                                                         origin = "country.name",
                                                         destination = "iso3c",
                                                         nomatch = NULL
    )))
  
  countrynam <- levels(as.factor(world$Country))
  
  # Find all countries in the list and replace with correct country name (then fill in remaining NAs)
  gap <- ifelse(country %in% countrynam, country, NA)
  gaplist <- na.locf(gap)
  
  # Create new dataframe with correct countrynames
  acapslist <- cbind.data.frame(country, gaplist)
  acapslist <- acapslist[!acapslist$country %in% countrynam, ]
  acapslist <- acapslist %>%
    filter(country != "Countrylevel")
  
  # Create new column with the risk scores (and duplicate for missing rows up until the correct value)
  acapslist$risk <- suppressWarnings(ifelse(!is.na(as.numeric(as.character(acapslist$country))), as.numeric(as.character(acapslist$country)), NA))
  acapslist$risk <- c(na.locf(acapslist$risk), NA)
  
  # Remove duplicate rows and numeric rows
  acapslist <- acapslist %>%
    filter(is.na(as.numeric(as.character(country)))) %>%
    filter(country != "Country level") %>%
    filter(country != "Country Level") %>%
    filter(country != "")
  
  # Save csv with full acapslist
  write.csv(acapslist, "Indicator_dataset/acaps.csv")
  
  # List of countries with specific hazards
  conflictnams <- acapslist %>%
    filter(str_detect(acapslist$country, c("conflict|Crisis|crisis|Conflict|Refugees|refugees|
                                         Migration|migration|violence|violence|Boko Haram"))) %>%
    filter(risk >= 4) %>%
    dplyr::select(gaplist)
  
  conflictnams <- unique(conflictnams)
  
  # Food security countries
  foodnams <- acapslist[str_detect(acapslist$country, c("Food|food|famine|famine")), ] %>%
    filter(risk >= 4) %>%
    dplyr::select(gaplist)
  
  foodnams <- unique(foodnams)
  
  # Natural hazard countries
  naturalnams <- acapslist[str_detect(acapslist$country, c("Floods|floods|Drought|drought|Cyclone|cyclone|
                                                          Flooding|flooding|Landslides|landslides|
                                                          Earthquake|earthquake")), ] %>%
    filter(risk >= 3) %>%
    dplyr::select(gaplist)
  
  naturalnams <- unique(naturalnams)
  
  # Epidemic countries
  healthnams <- acapslist[str_detect(acapslist$country, c("Epidemic|epidemic")), ] %>%
    filter(risk >= 3) %>%
    dplyr::select(gaplist)
  
  healthnams <- unique(healthnams)
  
  # Load countries in the CRM
  countrylist <- read.csv(paste0(github, "Indicator_dataset/countrylist.csv"))
  
  acapssheet <- countrylist %>%
    dplyr::select(-X) %>%
    mutate(
      Fr_conflict_acaps = case_when(
        Country %in% unlist(as.list(conflictnams)) ~ 10,
        TRUE ~ 0
      ),
      H_health_acaps = case_when(
        Country %in% unlist(as.list(healthnams)) ~ 10,
        TRUE ~ 0
      ),
      NH_natural_acaps = case_when(
        Country %in% unlist(as.list(naturalnams)) ~ 10,
        TRUE ~ 0
      ),
      F_food_acaps = case_when(
        Country %in% unlist(as.list(foodnams)) ~ 10,
        TRUE ~ 0
      )
    )
  
  # Write ACAPS sheet
  write.csv(acapssheet, "Risk_sheets/acapssheet.csv")
  
  lap <- Sys.time() - lapStart
  print(paste("ACAPS sheet written", lap, units(lap)))
  lapStart <- Sys.time()
  #
  ##
  ### ********************************************************************************************
  ####    HEALTH: CREATE HEALTH SHEET USING A RANGE OF SOURCE INDICATORS ----
  ### ********************************************************************************************
  ##
  #
  
  #--------------------—HIS Score-----------------
  HIS <- read.csv(paste0(github, "Indicator_dataset/HIS.csv"))
  
  HIS <- HIS %>%
    rename(Country = H_Country) %>%
    dplyr::select(-X)
  
  #Normalise scores
  HIS <- normfuncneg(HIS, 20, 70, "H_HIS_Score")
  
  #-----------------------—Oxford rollback Score-----------------
  #OXrollback <- read.csv("https://raw.githubusercontent.com/OxCGRT/covid-policy-scratchpad/master/rollback_checklist/rollback_checklist.csv")
  
  # Risk of Openness is the reviewed, and updated, version of Oxford Rollback.
  OXrollback <- read.csv("https://raw.githubusercontent.com/OxCGRT/covid-policy-scratchpad/master/risk_of_openness_index/data/riskindex_timeseries_latest.csv")
  
  # Remove NAs and select columns
  # Risk of Openness is a time series; select most recent
  OXrollback <- OXrollback[!is.na(OXrollback$openness_risk),c("CountryCode", "Date", "openness_risk")] %>%
    mutate(Date = as.Date(Date)) %>%
    arrange(desc(Date)) %>%
    { .[!duplicated(.$CountryCode),] } %>%
    dplyr::select(-Date)
  
  colnames(OXrollback) <- paste0("H_", colnames(OXrollback))
  
  OXrollback <- OXrollback %>%
    rename(
      H_Oxrollback_score = H_openness_risk,
      Country = H_CountryCode
    ) #%>%
  # mutate(
  #   Country = countrycode(Countryname,
  #   origin = "country.name",
  #   destination = "iso3c",
  #   nomatch = NULL
  # ))
  
  upperrisk <- quantile(OXrollback$H_Oxrollback_score, probs = c(0.9), na.rm = T)
  lowerrisk <- quantile(OXrollback$H_Oxrollback_score, probs = c(0.1), na.rm = T)
  
  OXrollback <- normfuncpos(OXrollback, upperrisk, lowerrisk, "H_Oxrollback_score")
  
  #------------------------—COVID deaths and cases--------------------------
  # Switching to `read_csv()` may save ~2 seconds of Health's ~40 seconds; 6 → 4 secs
  covidweb <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv")
  
  covid <- covidweb %>%
    mutate(date = as.Date(date)) %>%
    filter(date > Sys.Date() - 28)
  
  # bi-weekly growth rate for covid deaths and cases
  covidgrowth <- covid %>%
    mutate(
      previous2week = case_when(
        date >= Sys.Date() - 13 ~ "twoweek",
        TRUE ~ "lasttwoweek"
      )) %>%
    group_by(iso_code, previous2week) %>%
    summarise(
      meandeaths = mean(new_deaths_per_million, na.rm = T),
      meancase = mean(new_cases_per_million, na.rm = T),
    )
  
  covidgrowth <- covidgrowth %>%
    group_by(iso_code) %>%
    filter(!is.na(meandeaths) & !is.na(meancase)) 
  
  # remove countries without two weeks
  # Slow (~4 seconds)
  covidgrowth <- covidgrowth %>%
    mutate(remove = iso_code %in% 
             as.data.frame(covidgrowth %>% 
                             dplyr::count(iso_code) %>% 
                             filter(n == 2) %>% 
                             dplyr::select(iso_code))$iso_code)
  
  # Calculate variables of interest
  covidgrowth <- covidgrowth %>%
    filter(remove == TRUE) %>%
    mutate(
      growthdeath = meandeaths[previous2week == "twoweek"] - meandeaths,
      growthratedeaths = case_when(
        meandeaths[previous2week == "lasttwoweek"] == 0 ~ 0.01,
        meandeaths > 0 ~ growthdeath / meandeaths[previous2week == "lasttwoweek"] * 100,
        TRUE ~ NA_real_
      ),
      growthcase = meancase[previous2week == "twoweek"] - meancase,
      growthratecases = case_when(
        meandeaths[previous2week == "lasttwoweek"] == 0 ~ 0.01,
        meancase > 0 ~ growthcase / meancase[previous2week == "lasttwoweek"] * 100,
        TRUE ~ NA_real_
      )
    ) %>%
    dplyr::filter(previous2week != "twoweek") %>%
    dplyr::select(-previous2week, -growthcase, -growthdeath, -meandeaths, -meancase, -remove)
  
  # Normalised scores for deaths
  covidgrowth <- normfuncpos(covidgrowth, 150, 0, "growthratedeaths")
  covidgrowth <- normfuncpos(covidgrowth, 150, 0, "growthratecases")
  
  # Rename columns
  colnames(covidgrowth) <- c(
    "Country", "H_Covidgrowth_biweeklydeaths", "H_Covidgrowth_biweeklycases",
    "H_Covidgrowth_deathsnorm", "H_Covidgrowth_casesnorm"
  )
  
  # Varibles on number of cases
  covidcurrent <- covid %>% 
    group_by(iso_code) %>%
    top_n(n = 1, date) %>%
    # filter(date == Sys.Date() - 1) %>%
    # filter(date == max(date)) %>% # This does not select the most recent date for each country
    dplyr::select(iso_code, new_cases_smoothed_per_million, new_deaths_smoothed_per_million) %>%
    rename(Country = iso_code)
  
  covidcurrent <- normfuncpos(covidcurrent, 250, 0, "new_cases_smoothed_per_million")
  covidcurrent <- normfuncpos(covidcurrent, 5, 0, "new_deaths_smoothed_per_million")
  
  # Rename columns
  colnames(covidcurrent) <- c(
    "Country", "H_new_cases_smoothed_per_million", "H_new_deaths_smoothed_per_million",
    "H_new_cases_smoothed_per_million_norm", "H_new_deaths_smoothed_per_million_norm"
  )
  
  # #—(Alternative COVID deaths)
  # # Load COVID data
  # cov <- read.csv("https://raw.githubusercontent.com/scc-usc/ReCOVER-COVID-19/master/results/forecasts/global_deaths_current_0.csv")
  # cov_current <- read.csv("https://raw.githubusercontent.com/scc-usc/ReCOVER-COVID-19/master/results/forecasts/global_deaths.csv")
  # 
  # # Summarise country totals (forecast)
  # cov_dat <- cov %>%
  #   dplyr::select(Country, colnames(cov)[10], colnames(cov)[9]) %>%
  #   rename(
  #     w8forecast = colnames(cov)[10], 
  #     w7forecast = colnames(cov)[9]
  #     ) %>%
  #   mutate(Country = suppressWarnings(countrycode(Country, 
  #                                                 origin = "country.name",
  #                                                 destination = "iso3c"
  #                                                 )
  #          )) %>%
  #   drop_na(Country)
  # 
  # # Summarise country totals (current)
  # cov_cur <- cov_current %>%
  #   dplyr::select(Country, last(colnames(cov_current))) %>%
  #   rename(
  #     current = last(colnames(cov_current)),
  #     ) %>%
  #   mutate(
  #     Country = suppressWarnings(countrycode(Country, 
  #                                                 origin = "country.name",
  #                                                 destination = "iso3c"
  #                                            )
  #       )) %>%
  #   drop_na(Country)
  # 
  # # Add population
  # pop <- wpp.by.year(wpp.indicator("tpop"), 2020)
  # 
  # pop$charcode <- suppressWarnings(countrycode(pop$charcode, 
  #                                              origin = "iso2c", 
  #                                              destination = "iso3c"
  #                                              )
  #                                  )
  # 
  # colnames(pop) <- c("Country", "Population")
  # 
  # # Join datasets
  # cov_forcast_alt <- left_join(cov_dat, pop, by = "Country", keep = F) %>%
  #   left_join(., cov_cur) %>%
  #   drop_na(Country) %>%
  #   mutate(
  #     week_increase = w8forecast - w7forecast,
  #     new_death_per_m = week_increase / (Population / 1000),
  #     add_death_prec_current = ((w8forecast / current) * 100) - 100
  #     ) %>%
  #   rename_with(.fn = ~ paste0("H_", .), 
  #               .cols = colnames(.)[-1]
  #               )
  # 
  # # Normalise
  # cov_forcast_alt <- normfuncpos(cov_forcast_alt, 100, 0, "H_add_death_prec_current")
  
  #--------------------------—Oxford Response Tracker----------------------------
  # SLOW: 10 seconds with w/ `read.csv`, 5 with `read_csv`
  Oxres <- read.csv("https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv")
  
  #Select latest data
  Ox_cov_resp <- Oxres %>%
    group_by(CountryCode) %>%
    filter(Date == max(Date)) %>%
    dplyr::select(
      CountryCode, Date, GovernmentResponseIndex, GovernmentResponseIndexForDisplay,
      EconomicSupportIndex, EconomicSupportIndexForDisplay, ContainmentHealthIndex,
      ContainmentHealthIndexForDisplay, E1_Income.support, E1_Flag
    )
  
  colnames(Ox_cov_resp) <- c("Country", paste0("H_", colnames(Ox_cov_resp[,-1])))
  
  #Create normalised scores
  Ox_cov_resp <- normfuncneg(Ox_cov_resp, 15, 80, "H_GovernmentResponseIndexForDisplay")
  Ox_cov_resp <- normfuncneg(Ox_cov_resp, 0, 100, "H_EconomicSupportIndexForDisplay")
  
  #------------------------------—INFORM COVID------------------------------------------------------
  # SLOW
  inform_cov <- read_html("https://drmkc.jrc.ec.europa.eu/inform-index/INFORM-Covid-19/INFORM-Covid-19-Warning-beta-version")
  
  all_dat <- lapply(2:24, function(tt) {
    see <- lapply(c("data-country", "data-value", "style"), function(xx) {
      inform_cov %>% 
        html_nodes(paste0("td:nth_child(", paste(tt), ")")) %>%
        html_attr(xx)
    })
    do.call(rbind, Map(data.frame, cname = see[1], Value = see[2], Rating = see[3]))
  })
  
  inform_covid_warning_raw <- do.call(rbind, Map(data.frame, INFORM_rating=all_dat[1], covid_case_rate=all_dat[2], legal_stringency=all_dat[3],
                                                 international_travel=all_dat[4], internal_movement=all_dat[5], stay_home=all_dat[6],
                                                 income_support=all_dat[7], debt_relief=all_dat[8], gdp_change=all_dat[9],
                                                 unemployment=all_dat[10], inflation=all_dat[11], school_close=all_dat[12],
                                                 ipc_3_plus=all_dat[13], growth_events=all_dat[14], public_info=all_dat[15],
                                                 testing_policy=all_dat[16], contact_trace=all_dat[17], growth_conflict=all_dat[18],
                                                 seasonal_flood=all_dat[19], seasonal_cyclone=all_dat[20], seasonal_exposure=all_dat[21],
                                                 ASAP_hotspot=all_dat[22]))
  
  severity <- as.data.frame(all_dat[23]) %>%
    rename(INFORM_rating.cname = cname,
           INFORM_severity.Value = Value,
           INFORM_severity.Rating = Rating)
  
  inform_covid_warning_raw <- left_join(inform_covid_warning_raw, severity, by = "INFORM_rating.cname")
  
  inform_covid_warning <-  inform_covid_warning_raw %>%
    rename(
      Countryname = INFORM_rating.cname,
      hold_one = INFORM_severity.Rating
    ) %>%
    dplyr::select(-contains(".cname")) %>%
    mutate_at(
      vars(contains(".Rating")),
      ~ case_when(
        . == "background:#FF0000;" ~ "High",
        . == "background:#FFD800;" ~ "Medium",
        . == "background:#00FF00;" ~ "Low",
        TRUE ~ NA_character_
      )
    ) %>%
    mutate(
      hold_one = case_when(
        hold_one == "background:#FF0000;" ~ "High",
        hold_one == "background:#FFD800;" ~ "Medium",
        is.na(hold_one) ~ "Low",
        TRUE ~ NA_character_
      )) %>%
    rename(INFORM_severity.Rating = hold_one) %>%
    mutate(
      INFORM_rating.Value = as.numeric(as.character(INFORM_rating.Value)),
      Country = countrycode(Countryname, origin = "country.name", destination = "iso3c", nomatch = NULL
      )) %>%
    dplyr::select(-Countryname) %>%
    rename_with(
      .fn = ~ paste0("H_", .), 
      .cols = colnames(.)[!colnames(.) %in% c("Country", "Countryname")]
    )
  
  inform_covid_warning <- normfuncpos(inform_covid_warning, 6, 2, "H_INFORM_rating.Value")
  
  write.csv(inform_covid_warning, "Indicator_dataset/inform_covid_warning.csv")
  # FIX: for databricks, will need to replace this with copy_to a spark table, or similar
  
  #----------------------------------—WMO DONS--------------------------------------------------------------
  dons_raw <- read_html("https://www.who.int/emergencies/disease-outbreak-news")
  # FIX: same error as for reading acaps. Note that read_html() does work in databricks; works for inform_cov
  
  dons_select <- dons_raw %>%
    html_nodes(".sf-list-vertical") %>%
    html_nodes("h4") #%>%
  #html_text()
  
  dons_date <- dons_select %>%
    html_nodes("span:nth-child(2)") %>%
    html_text()
  
  dons_text <- dons_select %>%
    html_nodes(".trimmed") %>%
    html_text()
  
  wmo_don_full <- bind_cols(dons_text, dons_date) %>%
    rename(text = "...1" ,
           date = "...2") %>%
    mutate(disease = trimws(sub("\\s[-——].*", "", text)),
           country = trimws(sub(".*–", "", text)),
           country = trimws(sub(".*-", "", country)),
           date = dmy(date)) %>%
    separate_rows(country, sep = ",") %>%
    mutate(wmo_country_alert = countrycode(country,
                                           origin = "country.name",
                                           destination = "iso3c",
                                           nomatch = NULL
    ))
  
  countrylist <- read.csv(paste0(github, "Indicator_dataset/countrylist.csv"))
  wmo_don <- countrylist %>%
    dplyr::select(-X) %>%
    mutate(wmo_don_alert = case_when(Country %in% wmo_don_full$wmo_country_alert ~ 10,
                                     TRUE ~ 0))  %>%
    rename(H_wmo_don_alert = wmo_don_alert) %>%
    dplyr::select(-Countryname)
  
  #---------------------------------—Health ACAPS---------------------------------
  acaps_health <- acapssheet[,c("Country", "H_health_acaps")]
  
  #----------------------------------—Create combined Health Sheet-------------------------------------------
  countrylist <- read.csv(paste0(github, "Indicator_dataset/countrylist.csv"))
  countrylist <- countrylist %>%
    dplyr::select(-X)
  
  health_sheet <- left_join(countrylist, HIS, by = "Country") %>%
    left_join(., OXrollback, by = "Country") %>%
    left_join(., covidgrowth, by = "Country") %>%
    left_join(., covidcurrent, by = "Country") %>%
    left_join(., Ox_cov_resp, by = "Country") %>%
    # left_join(., cov_forcast_alt, by = "Country") %>% # not current
    left_join(., inform_covid_warning, by = "Country", "Countryname") %>%
    left_join(., wmo_don, by = "Country") %>%
    left_join(., acaps_health, by = "Country") %>%
    arrange(Country)
  
  write.csv(health_sheet, "Risk_sheets/healthsheet.csv")

  lap <- Sys.time() - lapStart
  print(paste("Health sheet written", lap, units(lap)))
  lapStart <- Sys.time()
  #
  ##
  ### ********************************************************************************************
  ####    FOOD SECURITY: CREATE FOOD SECURITY SHEET USING A RANGE OF SOURCE INDICATORS ----
  ### ********************************************************************************************
  ##
  #
  
  #---------------------------------—LOAD FOOD SECURITY DATA---------------------------
  # -------------------------------— Proteus Index -------------------------------
  proteus <- read.csv(paste0(github, "Indicator_dataset/proteus.csv"))
  
  proteus <- proteus %>%
    rename(F_Proteus_Score = Proteus.index) %>%
    dplyr::select(-X) %>%
    mutate(
      Country = countrycode(Country,
                            origin = "country.name",
                            destination = "iso3c",
                            nomatch = NULL
      ))
  
  upperrisk <- quantile(proteus$F_Proteus_Score, probs = c(0.90), na.rm = T)
  lowerrisk <- quantile(proteus$F_Proteus_Score, probs = c(0.10), na.rm = T)
  proteus <- normfuncpos(proteus, upperrisk, lowerrisk, "F_Proteus_Score")
  
  #------------------—FEWSNET (with CRW threshold)---
  
  #Load database
  fewswb <- suppressMessages(read_csv(paste0(github, "Indicator_dataset/fews.csv"), col_types = cols()))
  
  #Calculate country totals
  fewsg <- fewswb %>%
    #  dplyr::select(-X) %>%
    group_by(country, year_month) %>%
    mutate(countrypop = sum(pop)) %>%
    ungroup()
  
  #Calculate proportion and number of people in IPC class 
  fewspop <- fewsg %>%
    group_by(country, year_month) %>%
    mutate(
      countryproportion = (pop / countrypop) * 100,
      ipc3plusabsfor = case_when(fews_proj_med_adjusted >=3 ~ pop,
                                 TRUE ~ NA_real_),
      ipc3pluspercfor = case_when(fews_proj_med_adjusted >=3 ~ countryproportion,
                                  TRUE ~ NA_real_),
      ipc4plusabsfor = case_when(fews_proj_med_adjusted >= 4 ~ pop,
                                 TRUE ~ NA_real_),
      ipc4pluspercfor = case_when(fews_proj_med_adjusted >= 4 ~ countryproportion,
                                  TRUE ~ NA_real_),
      ipc3plusabsnow = case_when(fews_ipc_adjusted >=3 ~ pop,
                                 TRUE ~ NA_real_),
      ipc3pluspercnow = case_when(fews_ipc_adjusted >=3 ~ countryproportion,
                                  TRUE ~ NA_real_),
      ipc4plusabsnow = case_when(fews_ipc_adjusted >= 4 ~ pop,
                                 TRUE ~ NA_real_),
      ipc4pluspercnow = case_when(fews_ipc_adjusted >= 4 ~ countryproportion,
                                  TRUE ~ NA_real_)
    )
  
  #Functions to calculate absolute and geometric growth rates
  pctabs <- function(x) x- lag(x)
  pctperc <- function(x) x - lag(x) / lag(x)
  
  #Summarise country totals per in last round of FEWS
  fewssum <- fewspop %>%
    filter(year_month == "2021_02" | year_month == "2020_10") %>%
    group_by(country, year_month) %>%
    mutate(totalipc3plusabsfor = sum(ipc3plusabsfor, na.rm=T),
           totalipc3pluspercfor = sum(ipc3pluspercfor, na.rm=T),
           totalipc4plusabsfor = sum(ipc4plusabsfor, na.rm=T),
           totalipc4pluspercfor = sum(ipc4pluspercfor, na.rm=T),
           totalipc3plusabsnow = sum(ipc3plusabsnow, na.rm=T),
           totalipc3pluspercnow = sum(ipc3pluspercnow, na.rm=T),
           totalipc4plusabsnow = sum(ipc4plusabsnow, na.rm=T),
           totalipc4pluspercnow = sum(ipc4pluspercnow, na.rm=T)) %>%
    distinct(country, year_month, .keep_all = TRUE) %>%
    dplyr::select(-ipc3plusabsfor, -ipc3pluspercfor, -ipc4plusabsfor, -ipc4pluspercfor, 
                  -ipc3plusabsnow, -ipc3pluspercnow, -ipc4plusabsnow, -ipc4pluspercnow,
                  -admin_name, -pop) %>%
    group_by(country) %>%
    mutate(pctchangeipc3for = pctabs(totalipc3pluspercfor),
           pctchangeipc4for = pctperc(totalipc4pluspercfor),
           pctchangeipc3now = pctabs(totalipc3pluspercnow),
           pctchangeipc4now = pctperc(totalipc4pluspercnow),
           diffactfor = totalipc3pluspercfor - totalipc3pluspercnow,
           fshighrisk = case_when((totalipc3plusabsfor >= 5000000 | totalipc3pluspercfor >= 20) & pctchangeipc3for >= 5  ~ "High risk",
                                  (totalipc3plusabsnow >= 5000000 | totalipc3pluspercnow >= 20) & pctchangeipc3now >= 5  ~ "High risk",
                                  totalipc4pluspercfor >= 2.5  & pctchangeipc4for >= 10  ~ "High risk",
                                  totalipc4pluspercnow >= 2.5  & pctchangeipc4now >= 10  ~ "High risk",
                                  TRUE ~ "Not high risk")) %>%
    dplyr::select(-fews_ipc, -fews_ha, -fews_proj_near, -fews_proj_near_ha, -fews_proj_med, 
                  -fews_proj_med_ha, -fews_ipc_adjusted, -fews_proj_med_adjusted, -countryproportion) %>%
    filter(year_month == "2021_02")
  
  # Find max ipc for any region in the country
  fews_summary <- fewsg %>%
    group_by(country, year_month) %>%
    summarise(max_ipc = max(fews_proj_med_adjusted, na.rm = T)) %>%
    mutate(
      year_month = str_replace(year_month, "_", "-"),
      year_month = as.Date(as.yearmon(year_month)),
      year_month = as.Date(year_month)) %>%
    filter(!is.infinite(max_ipc)) %>%
    filter(year_month == max(year_month, na.rm = T))
  
  # Join the two datasets
  fews_dataset <- left_join(fewssum, fews_summary, by = "country") %>%
    mutate(
      fews_crm_norm = case_when(
        fshighrisk == "High risk" ~ 10,
        fshighrisk != "High risk" & max_ipc == 5 ~ 9,
        fshighrisk != "High risk" & max_ipc == 4 ~ 8,
        fshighrisk != "High risk" & max_ipc == 3 ~ 7,
        fshighrisk != "High risk" & max_ipc == 2 ~ 5,
        fshighrisk != "High risk" & max_ipc == 1 ~ 3,
        TRUE ~ NA_real_
      ),
      Country = countrycode(
        country,
        origin = "country.name",
        destination = "iso3c",
        nomatch = NULL
      )) %>%
    dplyr::select(-country) %>%
    rename_with(
      .fn = ~ paste0("F_", .),
      .cols = colnames(.)[!colnames(.) %in% c("Country", "country")]
    )
  
  colnames(fews_dataset[-1]) <- paste0("F_", colnames(fews_dataset[-1])) 
  
  #------------------------—WBG FOOD PRICE MONITOR------------------------------------
  ag_ob_data <- read.csv(paste0(github, "Indicator_dataset/food-inflation.csv"))

  ag_ob_data <- ag_ob_data %>%
  mutate_at(
    vars(contains("19"), contains("20"), contains("21")),
    ~ as.numeric(as.character(gsub(",", ".", .)))
  )

  ag_ob <- ag_ob_data %>%
  filter(X == "Food Change Yoy") %>%
  dplyr::select(-Income.Level, -Color.Bin, -X) %>%
  group_by(Country) %>%
  summarise(
    Mar = Mar.20[which(!is.na(Mar.20))[1]],
    Apr = Apr.20[which(!is.na(Apr.20))[1]],
    May = May.20[which(!is.na(May.20))[1]],
    June = Jun.20[which(!is.na(Jun.20))[1]],
    Jul = Jul.20[which(!is.na(Jul.20))[1]],
    Aug = Aug.20[which(!is.na(Aug.20))[1]],
    Sep = Sep.20[which(!is.na(Sep.20))[1]],
    Oct = Oct.20[which(!is.na(Oct.20))[1]],
    Nov = Nov.20[which(!is.na(Nov.20))[1]],
    Dec = Dec.20[which(!is.na(Dec.20))[1]],
    Jan = Jan.21[which(!is.na(Jan.21))[1]],
    Feb = Feb.21[which(!is.na(Feb.21))[1]]
      ) %>%
  mutate(fpv = case_when(
    !is.na(Feb) ~ Feb,
    is.na(Feb) & !is.na(Jan) ~ Jan,
    is.na(Feb) & is.na(Jan) & !is.na(Dec) ~ Nov,
    TRUE ~ NA_real_
  ),
  fpv_rating = case_when(
    fpv <= 0.02 ~ 1,
    fpv > 0.02 & fpv <= 0.05 ~ 3,
    fpv > 0.05 & fpv <= 0.30 ~ 5,
    fpv >= 0.30 ~ 7,
    TRUE ~ NA_real_
  ),
  Country = countrycode(Country,
                        origin = "country.name",
                        destination = "iso3c",
                        nomatch = NULL
  )) %>%
  rename_with(   
    .fn = ~ paste0("F_", .),
    .cols = colnames(.)[!colnames(.) %in% c("Country")]
  )
  
  #-------------------------—FAO/WFP HOTSPOTS----------------------------
  fao_wfp <- suppressWarnings(read_csv(paste0(github, "Indicator_dataset/WFP%3AFAO_food.csv"), col_types = cols()) %>%
                                dplyr::select(-X2))
  
  fao_wfp <- fao_wfp %>%
    mutate(Country = countrycode(Country,
                                 origin = "country.name",
                                 destination = "iso3c",
                                 nomatch = NULL
    ))
  
  fao_wfp$F_fao_wfp_warning <- 10
  
  #------------------------—Create combined Food Security sheet--------------------
  countrylist <- read.csv(paste0(github, "Indicator_dataset/countrylist.csv"))
  countrylist <- countrylist %>%
    dplyr::select(-X)
  
  food_sheet <- left_join(countrylist, proteus, by = "Country") %>%
    left_join(., fews_dataset, by = "Country") %>%
    # left_join(., fpv, by = "Country") %>%  # Reintroduce if FAO price site comes back online
    # left_join(., fpv_alt, by = "Country") %>% # not current
    # left_join(., artemis, by = "Country") %>% # not current
    left_join(., ag_ob, by = "Country") %>%
    left_join(., fao_wfp, by = "Country") %>%
    arrange(Country)
  
  write.csv(food_sheet, "Risk_sheets/foodsecuritysheet.csv")

  lap <- Sys.time() - lapStart
  print(paste("Food sheet written", lap, units(lap)))
  lapStart <- Sys.time()
  #
  ##
  ### ********************************************************************************************
  ####    MACRO: CREATE MACRO  SHEET USING A RANGE OF SOURCE INDICATORS ----
  ### ********************************************************************************************
  ##
  #
  
  #---------------------------—Economist Intelligence Unit---------------------------------
  url <- "https://github.com/bennotkin/compoundriskdata/blob/master/Indicator_dataset/RBTracker.xls?raw=true"
  destfile <- "RBTracker.xls"
  curl::curl_download(url, destfile)
  eiu_data <- read_excel(destfile, sheet = "Data Values", skip = 3)
  
  country_nam <- colnames(eiu_data) 
  country_nam <- country_nam[4:length(country_nam)]
  
  eiu_latest_month <- eiu_data %>%
    filter(MONTH == max(MONTH)) %>% 
    dplyr::select(-MONTH, -`SERIES CODE`) %>%
    #Pivot the database so countries are rows
    pivot_longer(
      !`SERIES NAME`,
      names_to = "Country",
      values_to = "Values"
    ) %>%
    pivot_wider(
      names_from = `SERIES NAME`,
      values_from = Values
    ) %>%
    rename(Macroeconomic_risk = `Macroeconomic risk`) %>%
    mutate(Macroeconomic_risk = (`Financial risk` + Macroeconomic_risk + `Foreign trade & payments risk`) / 3)
  
  eiu_one_year <- eiu_data %>%
    filter(MONTH %in% unique(eiu_data$MONTH)[-1]) %>%
    group_by(`SERIES NAME`) %>%
    summarise_at(country_nam, mean, na.rm = T) %>%
    ungroup %>%
    distinct(`SERIES NAME`, .keep_all = T) %>% 
    #Pivot the database so countries are rows
    pivot_longer(
      !`SERIES NAME`,
      names_to = "Country",
      values_to = "Values"
    ) %>%
    pivot_wider(
      names_from = `SERIES NAME`,
      values_from = Values
    ) %>%
    rename_with(
      .col = c(contains("risk"), contains("Overall")),
      .fn  = ~ paste0(., "_12")
    ) %>%
    rename(Macroeconomic_risk_12 = `Macroeconomic risk_12`) %>%
    mutate(Macroeconomic_risk_12 = (`Financial risk_12` + Macroeconomic_risk_12 + `Foreign trade & payments risk_12`) / 3)
  
  eiu_three_month <- eiu_data %>%
    filter(MONTH %in% head(unique(MONTH)[-1], 3)) %>%
    group_by(MONTH, `SERIES NAME`) %>%
    summarise_at(country_nam, mean, na.rm = T) %>%
    ungroup %>%
    dplyr::select(-MONTH) %>%
    distinct(`SERIES NAME`, .keep_all = T) %>% 
    #Pivot the database so countries are rows
    pivot_longer(
      !`SERIES NAME`,
      names_to = "Country",
      values_to = "Values"
    ) %>%
    pivot_wider(
      names_from = `SERIES NAME`,
      values_from = Values
    ) %>%
    rename_with(
      .col = c(contains("risk"), contains("Overall")),
      .fn  = ~ paste0(., "_3")
    ) %>%
    rename(Macroeconomic_risk_3 = `Macroeconomic risk_3`) %>%
    mutate(Macroeconomic_risk_3 = (`Financial risk_3` + Macroeconomic_risk_3 + `Foreign trade & payments risk_3`) / 3)
  
  # Join datasets
  eiu_joint <- left_join(eiu_latest_month, eiu_three_month, by = "Country") %>%
    left_join(., eiu_one_year, by = "Country") %>%
    mutate(
      EIU_3m_change = Macroeconomic_risk - Macroeconomic_risk_3,
      EIU_12m_change = Macroeconomic_risk - Macroeconomic_risk_12
    ) %>%
    dplyr::select(contains("Country"), contains("Macro"), contains("EIU")) %>%
    rename_with(
      .col = c(contains("Macro"), contains("EIU")),
      .fn = ~ paste0("M_", .)
    ) %>%
    rename(M_EIU_Score = `M_Macroeconomic_risk`,
           M_EIU_Score_12m = `M_Macroeconomic_risk_12`) %>%
    # Add Country name
    mutate(
      Country = suppressWarnings(countrycode(Country,
                                             origin = "country.name",
                                             destination = "iso3c",
                                             nomatch = NULL))
    )
  
  eiu_joint <- normfuncpos(eiu_joint, quantile(eiu_joint$M_EIU_Score, 0.90), quantile(eiu_joint$M_EIU_Score, 0.10), "M_EIU_Score")
  eiu_joint <- normfuncpos(eiu_joint, quantile(eiu_joint$M_EIU_12m_change, 0.90), quantile(eiu_joint$M_EIU_12m_change, 0.10), "M_EIU_12m_change")
  eiu_joint <- normfuncpos(eiu_joint, quantile(eiu_joint$M_EIU_Score_12m, 0.90), quantile(eiu_joint$M_EIU_Score_12m, 0.10), "M_EIU_Score_12m")
  
  #-----------------------------—Create Combined Macro sheet-----------------------------------------
  countrylist <- read.csv(paste0(github, "Indicator_dataset/countrylist.csv"))
  countrylist <- countrylist %>%
    dplyr::select(-X)
  
  macro_sheet <- #left_join(countrylist, macro, by = "Country") %>% # not current
    # left_join(., gdp, by = "Country") %>% # not current
    # left_join(., macrofin, by = "Country") %>% # not current
    left_join(countrylist, eiu_joint, by = "Country") %>%
    # left_join(., cvi, by = "Country") %>% # not current
    arrange(Country) 
  
  write.csv(macro_sheet, "Risk_sheets/macrosheet.csv")

  lap <- Sys.time() - lapStart
  print(paste("Macro sheet written", lap, units(lap)))
  lapStart <- Sys.time()
  #
  ##
  ### ********************************************************************************************
  ####    SOCIO: CREATE SOCIO-ECONOMIC SHEET USING A RANGE OF SOURCE INDICATORS ----
  ### ********************************************************************************************
  ##
  #
  
  #---------------------------—Alternative socio-economic data (based on INFORM)
  inform_2021 <- suppressMessages(read_csv(paste0(github, "Indicator_dataset/INFORM_2021.csv"), col_types = cols()))
  
  inform_data <- inform_2021 %>%
    dplyr::select(Country, "Socio-Economic Vulnerability") %>%
    rename(S_INFORM_vul = "Socio-Economic Vulnerability")
  
  inform_data <- normfuncpos(inform_data, 7, 0, "S_INFORM_vul")
  inform_data <- normfuncpos(inform_data, 7, 0, "S_INFORM_vul")
  
  #------------------------—Forward-looking socio-economic variables from INFORM---------------------------
  socio_forward <- inform_covid_warning %>%
    dplyr::select(
      Country, H_gdp_change.Value,H_gdp_change.Rating, H_unemployment.Value,
      H_unemployment.Rating, H_income_support.Value, H_income_support.Rating
    ) %>%
    rename_with(
      .fn = ~ str_replace(., "H_", "S_"),
      .cols = colnames(.)[-1]
    ) %>%
    mutate_at(
      vars(S_gdp_change.Rating, S_unemployment.Rating),
      funs(norm = case_when(
        . == "High" ~ 10,
        . == "Medium" ~ 7,
        . == "Low" ~ 0,
        TRUE ~ NA_real_
      ))
    ) %>%
    mutate(
      S_income_support.Rating_crm_norm = case_when(
        S_income_support.Value == "No income support" ~ 7,
        S_income_support.Value == "Government is replacing more than 50% of lost salary (or if a flat sum, it  ..." ~ 3,
        S_income_support.Value == "Government is replacing less than 50% of lost salary (or if a flat sum, it  ..." ~ 0,
        TRUE ~ NA_real_
      ))
  
  #--------------------------—MPO: Poverty projections----------------------------------------------------
  mpo_data <- read.csv("https://raw.githubusercontent.com/bennotkin/compoundriskdata/docker/Indicator_dataset/mpo.csv")
  # FIX: replace with paste0(github...)
  #-----------------------------—HOUSEHOLD HEATMAP FROM MACROFIN-------------------------------------
  # If Macro Fin Review is re-included above, we can reuse that. For clarity, moving data read here because it's not being used by macrosheet
  data <- read.csv(paste0(github, "Indicator_dataset/macrofin.csv"))
  
  macrofin <- data %>%
    mutate_at(
      vars(Monetary.and.financial.conditions, contains("risk")),
      funs(case_when(
        . == "Low" ~ 0,
        . == "Medium" ~ 0.5,
        . == "High" ~ 1,
        TRUE ~ NA_real_
      ))) %>%
    mutate(macrofin_risk = dplyr::select(., Spillover.risks.from.the.external.environment.outside.the.region:Household.risks) %>% rowSums(na.rm=T)) %>%
    rename_with(
      .fn = ~ paste0("M_", .),
      .cols = colnames(.)[!colnames(.) %in% c("Country.Name","ISO3")]
    ) %>%
    rename(Country = ISO3) %>%
    dplyr::select(-Country.Name)
  
  macrofin <- normfuncpos(macrofin, 2.1, 0, "M_macrofin_risk")
  
  household_risk <- macrofin %>%
    dplyr::select(Country, M_Household.risks) %>%
    mutate(M_Household.risks_raw = M_Household.risks,
           M_Household.risks = case_when(
             M_Household.risks == 0.5 ~ 7,
             M_Household.risks == 1 ~ 10,
             TRUE ~ M_Household.risks
           )) %>%
    rename(S_Household.risks = M_Household.risks,
           S_Household.risks_raw = M_Household.risks_raw)
  
  #----------------------------—WB PHONE SURVEYS-----------------------------------------------------
  phone_index_data <- read.csv(paste0(github, "Indicator_dataset/phone.csv"))
  
  #------------------------------—IMF FORECASTED UNEMPLOYMENT-----------------------------------------
  imf_un <- read.csv(paste0(github, "Indicator_dataset/imf_unemployment.csv"))
  
  imf_un <- imf_un %>%
    mutate(across(
      contains("X2"),
      ~ as.numeric(as.character(.)))
    ) %>%
    mutate(change_unemp_21 = X2021 - X2020,
           change_unemp_20 = X2020 - X2019) %>%
    rename(
      Countryname = Country,
      Country = ISO3
    ) %>%
    rename_with(
      .fn = ~ paste0("S_", .),
      .cols = -contains("Country")
    ) %>%
    dplyr::select(-Countryname) %>%
    filter(S_Subject.Descriptor == "Unemployment rate")
  
  # Normalise values
  imf_un <- normfuncpos(imf_un, 1, 0, "S_change_unemp_21")
  imf_un <- normfuncpos(imf_un, 3, 0, "S_change_unemp_20")
  
  # Max values for index
  imf_un <- imf_un %>%
    mutate(
      S_change_unemp_norm = rowMaxs(as.matrix(dplyr::select(.,
                                                            S_change_unemp_21_norm,
                                                            S_change_unemp_20_norm)),
                                    na.rm = T),
      S_change_unemp_norm = case_when(is.infinite(S_change_unemp_norm) ~ NA_real_,
                                      TRUE ~ S_change_unemp_norm)
    )
  
  #--------------------------—Create Socioeconomic sheet -------------------------------------------
  socioeconomic_sheet <- #left_join(countrylist, ocha, by = "Country") %>% # not current
    #dplyr::select(-Countryname) %>%
    left_join(countrylist, inform_data, by = "Country") %>%
    left_join(., socio_forward, by = "Country") %>%
    left_join(., mpo_data, by = "Country") %>%
    left_join(., imf_un, by = "Country") %>%
    left_join(., household_risk, by = "Country") %>%
    left_join(., phone_index_data, by = "Country") %>%
    arrange(Country)
  
  write.csv(socioeconomic_sheet, "Risk_sheets/Socioeconomic_sheet.csv")

  lap <- Sys.time() - lapStart
  print(paste("Socioeconomic sheet written", lap, units(lap)))
  lapStart <- Sys.time()
  #
  ##
  ### ********************************************************************************************
  ####    NATURAL HAZARD: CREATE NATURAL HAZARDS SHEET USING A RANGE OF SOURCE INDICATORS -----
  ### ********************************************************************************************
  ##
  #
  
  #-------------------------------—NATURAL HAZARDS SHEET------------------------------------------------
  
  #------------------------------—Load GDACS database--------------------------------------------------
  gdacweb <- "https://www.gdacs.org/"
  gdac <- read_html(gdacweb)
  
  names <- c(
    ".alert_EQ_Green", ".alert_EQ_PAST_Green", ".alert_EQ_Orange", ".alert_EQ_PAST_Orange",
    ".alert_TC_Green", ".alert_TC_PAST_Green", ".alert_TC_Orange", ".alert_TC_PAST_Orange",
    ".alert_FL_Green", ".alert_FL_PAST_Green", ".alert_FL_Orange", ".alert_FL_PAST_Orange",
    ".alert_VO_Green", ".alert_VO_PAST_Green", ".alert_VO_Orange", ".alert_VO_PAST_Orange",
    ".alert_DR_Green", ".alert_DR_PAST_Green", ".alert_DR_Orange", ".alert_DR_PAST_Orange"
  )
  
  # Function to create database with hazard specific information
  haz <- lapply(names, function(i) {
    names <- gdac %>%
      html_nodes(i) %>%
      html_nodes(".alert_item_name, .alert_item_name_past") %>%
      html_text()
    
    mag <- gdac %>%
      html_nodes(i) %>%
      html_nodes(".magnitude, .magnitude_past") %>%
      html_text() %>%
      str_trim()
    
    date <- gdac %>%
      html_nodes(i) %>%
      html_nodes(".alert_date, .alert_date_past") %>%
      html_text() %>%
      str_trim()
    date <- gsub(c("-  "), "", date)
    date <- gsub(c("\r\n       "), "", date)
    
    cbind.data.frame(names, mag, date)
  })
  
  # Labels
  try(haz[[1]]$status <- paste("active"), silent = T)
  try(haz[[2]]$status <- paste("past"), silent = T)
  try(haz[[3]]$status <- paste("active"), silent = T)
  try(haz[[4]]$status <- paste("past"), silent = T)
  try(haz[[5]]$status <- paste("active"), silent = T)
  try(haz[[6]]$status <- paste("past"), silent = T)
  try(haz[[7]]$status <- paste("active"), silent = T)
  try(haz[[8]]$status <- paste("past"), silent = T)
  try(haz[[9]]$status <- paste("active"), silent = T)
  try(haz[[10]]$status <- paste("past"), silent = T)
  try(haz[[11]]$status <- paste("active"), silent = T)
  try(haz[[12]]$status <- paste("past"), silent = T)
  try(haz[[13]]$status <- paste("active"), silent = T)
  try(haz[[14]]$status <- paste("past"), silent = T)
  try(haz[[15]]$status <- paste("active"), silent = T)
  try(haz[[16]]$status <- paste("past"), silent = T)
  try(haz[[17]]$status <- paste("active"), silent = T)
  try(haz[[18]]$status <- paste("past"), silent = T)
  try(haz[[19]]$status <- paste("active"), silent = T)
  try(haz[[20]]$status <- paste("past"), silent = T)
  
  # Earthquake
  eq1 <- try(rbind(haz[[1]], haz[[2]]), silent = T)
  try(eq1$haz <- paste("green"), silent = T)
  eq2 <- try(rbind(haz[[3]], haz[[4]]), silent = T)
  try(eq2$haz <- paste("orange"), silent = T)
  eq <- try(rbind(eq1, eq2), silent = T)
  eq$hazard <- "earthquake"
  
  # Cyclone
  cy1 <- try(rbind(haz[[5]], haz[[6]]), silent = T)
  try(cy1$haz <- paste("green"), silent = T)
  cy2 <- try(rbind(haz[[7]], haz[[8]]), silent = T)
  try(cy2$haz <- paste("orange"), silent = T)
  cy <- try(rbind(cy1, cy2), silent = T)
  cy$hazard <- "cyclone"
  
  # Flood
  fl1 <- try(rbind(haz[[9]], haz[[10]]), silent = T)
  try(fl1$haz <- paste("green"), silent = T)
  fl2 <- try(rbind(haz[[11]], haz[[12]]), silent = T)
  try(fl2$haz <- paste("orange"), silent = T)
  fl <- try(rbind(fl1, fl2), silent = T)
  fl$hazard <- "flood"
  
  # Volcano
  vo1 <- try(rbind(haz[[13]], haz[[14]]), silent = T)
  try(vo1$haz <- paste("green"), silent = T)
  vo2 <- try(rbind(haz[[15]], haz[[16]]), silent = T)
  try(vo2$haz <- paste("orange"), silent = T)
  vo <- try(rbind(vo1, vo2), silent = T)
  vo$hazard <- "volcano"
  vo$names <- sub(".*in ", "", vo$names)
  
  # Drought
  dr1 <- try(rbind(haz[[17]], haz[[18]]), silent = T)
  dr1$haz <- try(paste("green"), silent = T)
  dr2 <- try(rbind(haz[[19]], haz[[20]]), silent = T)
  dr2$haz <- try(paste("orange"), silent = T)
  dr <- try(rbind(dr1, dr2), silent = T)
  dr$hazard <- "drought"
  dr$date <- try(str_sub(dr$names, start = -4), silent = T)
  dr$names <- try(gsub(".{5}$", "", dr$names), silent = T)
  
  # Combine into one dataframe
  gdaclist <- rbind.data.frame(eq, cy, fl, vo, dr)
  
  # change times
  gdaclist$date <- ifelse(gdaclist$hazard != c("drought") & gdaclist$status == "active", paste(as.Date(parse_date_time(gdaclist$date, orders = c("dm HM")))),
                          ifelse(gdaclist$hazard == c("drought"), paste(gdaclist$date),
                                 paste(as.Date(parse_date_time(gdaclist$date, orders = c("dmy"))))
                          )
  )
  
  # Remove duplicate countries for drought
  gdaclist$names <- as.character(gdaclist$names)
  add <- gdaclist[which(gdaclist$hazard == "drought" & grepl("-", gdaclist$names)), ]
  gdaclist[which(gdaclist$hazard == "drought" & grepl("-", gdaclist$names)), ]$names <- sub("-.*", "", gdaclist[which(gdaclist$hazard == "drought" & grepl("-", gdaclist$names)), ]$names)
  add$names <- sub(".*-", "", add$names)
  gdaclist <- rbind(gdaclist, add)
  
  # Drought orange
  gdaclist$status <- ifelse(gdaclist$hazard == "drought" & gdaclist$date == "2020", "active", gdaclist$status)
  
  # Country names
  gdaclist$namesiso <- suppressWarnings(countrycode(gdaclist$names, origin = "country.name", destination = "iso3c"))
  gdaclist$namesfull <- suppressWarnings(countrycode(gdaclist$names, origin = "country.name", destination = "iso3c", nomatch = NULL))
  
  # Create subset
  gdac <- gdaclist %>%
    dplyr::select(date, status, haz, hazard, namesiso)
  
  colnames(gdac) <- c("NH_GDAC_Date", "NH_GDAC_Hazard_Status", "NH_GDAC_Hazard_Severity", "NH_GDAC_Hazard_Type", "Country")
  
  gdac <- gdac %>%
    mutate(NH_GDAC_Hazard_Score_Norm = case_when(
      NH_GDAC_Hazard_Status == "active" & NH_GDAC_Hazard_Severity == "orange" ~ 10,
      TRUE ~ 0
    ),
    NH_GDAC_Hazard_Score = paste(NH_GDAC_Hazard_Status, NH_GDAC_Hazard_Severity, sep = " - ")
    ) %>%
    drop_na(Country)
  
  write.csv(gdac, "Indicator_dataset/gdaclistnormalised.csv")
  
  #----------------------—INFORM Natural Hazard and Exposure rating--------------------------
  
  inform_2021 <- read.csv(paste0(github, "Indicator_dataset/INFORM_2021.csv"))
  
  # Rename country
  informnathaz <- inform_2021 %>%
    dplyr::select(Country, Natural) %>%
    rename(NH_Hazard_Score = Natural) %>%
    drop_na(Country, NH_Hazard_Score)
  
  # Normalise scores
  informnathaz <- normfuncpos(informnathaz, 7, 1, "NH_Hazard_Score")
  
  #---------------------------------- —IRI Seasonal Forecast ------------------------------------------
  # Load from Github
  seasonl_risk <- suppressWarnings(read_csv(paste0(github, "Indicator_dataset/seasonal_risk_list"), col_types = cols()))
  seasonl_risk <- seasonl_risk %>%
    dplyr::select(-X1) %>%
    rename(
      Country = "ISO3",
      NH_seasonal_risk_norm = risklevel
    )
  
  #-------------------------------------—Locust outbreaks----------------------------------------------
  # List of countries and risk factors associated with locusts (FAO), see:http://www.fao.org/ag/locusts/en/info/info/index.html
  
  locust_risk <- suppressMessages(read_csv(paste0(github, "Indicator_dataset/locust_risk.csv"), col_types = cols()))
  locust_risk <- locust_risk %>%
    dplyr::select(-X1)
  #---------------------------------—Natural Hazard ACAPS---------------------------------
  acaps_nh <- acapssheet[,c("Country", "NH_natural_acaps")]
  
  #-------------------------------------------—Create combined Natural Hazard sheet------------------------------
  countrylist <- read.csv(paste0(github, "Indicator_dataset/countrylist.csv"))
  countrylist <- countrylist %>%
    dplyr::select(-X)
  
  nathazard_sheet <- left_join(countrylist, gdac, by = "Country") %>%
    left_join(., informnathaz, by = "Country") %>%
    left_join(., seasonl_risk, by = "Country") %>%
    left_join(., locust_risk, by = "Country") %>%
    left_join(., acaps_nh, by = "Country") %>%
    distinct(Country, .keep_all = TRUE) %>%
    drop_na(Country) %>%
    arrange(Country)
  
  write.csv(nathazard_sheet, "Risk_sheets/Naturalhazards.csv")

  lap <- Sys.time() - lapStart
  print(paste("Natural hazard sheet written", lap, units(lap)))
  lapStart <- Sys.time()
  #
  ##
  ### ********************************************************************************************
  ####    FRAGILITY: CREATE FRAGILITY  SHEET USING A RANGE OF SOURCE INDICATORS ----
  ### ********************************************************************************************
  ##
  #
  
  # SLOW: Takes 50 seconds.
  
  #-------------------------—FCS---------------------------------------------
  
  fcv <- read.csv(paste0(github, "Indicator_dataset/Country_classification.csv")) %>%
    dplyr::select(-X, Countryname, -IDA.status) %>%
    mutate(FCV_status = tolower(FCV_status)) %>%
    mutate(
      FCV_normalised = case_when(
        FCV_status == tolower("High-Intensity conflict") ~ 10,
        FCV_status == tolower("Medium-Intensity conflict") ~ 10,
        FCV_status == tolower("High-Institutional and Social Fragility") ~ 10,
        TRUE ~ 0
      )
    )
  
  #-----------------------------—IDPs--------------------------------------------------------
idp_data <- read_csv(paste0(github, "Indicator_dataset/population.csv"),
                      col_types = cols(
                        `IDPs of concern to UNHCR` = col_number(),
                        `Refugees under UNHCR mandate` = col_number(),
                        Year = col_number()
                      ), skip = 14
)

# Calculate metrics
idp <- idp_data %>%
  group_by(`Country of origin (ISO)`, Year) %>%
  summarise(
    refugees = sum(`Refugees under UNHCR mandate`, na.rm = T),
    idps = sum(`IDPs of concern to UNHCR`, na.rm = T)
  ) %>%
  group_by(`Country of origin (ISO)`) %>%
  mutate(
    sd_refugees = sd(refugees, na.rm = T),
    mean_refugees = mean(refugees, na.rm = T),
    z_refugees = (refugees - mean_refugees) / sd(refugees),
    refugees_fragile = case_when(
      z_refugees > 1 ~ "Fragile",
      z_refugees < 1 ~ "Not Fragile",
      z_refugees == NaN ~ "Not Fragile",
      TRUE ~ NA_character_
    ),
    mean_idps = mean(idps, na.rm = T),
    z_idps = case_when(
      sd(idps) != 0 ~ (idps - mean_idps) / sd(idps),
      sd(idps) == 0 ~ 0,
      TRUE ~ NA_real_
    ),
    idps_fragile = case_when(
      z_idps > 1 ~ "Fragile",
      z_idps < 1 ~ "Not Fragile",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(Year == 2020) %>%
  dplyr::select(`Country of origin (ISO)`, refugees, z_refugees, refugees_fragile, idps, z_idps, idps_fragile)

# Normalise scores
  idp <- normfuncpos(idp, 1, 0, "z_refugees")
  idp <- normfuncpos(idp, 1, 0, "z_idps")
  
  # Correct for countries with 0
  idp <- idp %>%
    mutate(
      z_refugees_norm = case_when(
        z_refugees == NaN ~ 0,
        TRUE ~ z_refugees_norm
      ),
      z_idps_norm = case_when(
        z_idps == NaN ~ 0,
        TRUE ~ z_idps_norm
      ),
      Country = countrycode(`Country of origin (ISO)`,
                            origin = "country.name",
                            destination = "iso3c",
                            nomatch = NULL
      )
    ) %>%
    dplyr::select(-`Country of origin (ISO)`)
  
  #-------------------------—ACLED data---------------------------------------------
  # Select date as three years plus two month (date to retrieve ACLED data)
  three_year <- as.Date(as.yearmon(Sys.Date() - 45) - 3.2)
  
  # Get ACLED API URL
  acled_url <- paste0("https://api.acleddata.com/acled/read/?key=*9t-89Rn*bDb4qFXBAmO&email=ljones12@worldbank.org&event_date=",
                      three_year,
                      "&event_date_where=>&fields=iso3|fatalities|event_date&limit=0")
  
  # #Get ACLED API URL
  # acled_url <- paste0("https://api.acleddata.com/acled/read/?key=buJ7jaXjo71EBBB!!PmJ&email=bnotkin@worldbank.org&event_date=",
  #                     three_year,
  #                     "&event_date_where=>&fields=iso3|fatalities|event_date&limit=0")
  
  # Retrieve information
  acled_data <- fromJSON(acled_url)
  
  # Progress conflict data
  acled <- acled_data$data %>%
    mutate(
      fatalities = as.numeric(as.character(fatalities)),
      date = as.Date(event_date),
      month_yr = as.yearmon(date)
    ) %>%
    # Remove dates for the latest month (or month that falls under the prior 6 weeks)
    filter(as.Date(as.yearmon(date)) <= as.Date(as.yearmon(Sys.Date() - 45))) %>% 
    group_by(iso3, month_yr) %>%
    summarise(fatal_month = sum(fatalities, na.rm = T),
              fatal_month_log = log(fatal_month + 1)) %>%
    mutate(fatal_3_month = fatal_month + lag(fatal_month, na.rm= T) + lag(fatal_month, 2, na.rm= T),
           fatal_3_month_log = log(fatal_3_month + 1)) %>%
    group_by(iso3) %>%
    mutate(
      fatal_z = (fatal_3_month_log - mean(fatal_3_month_log, na.rm = T)) / sd(fatal_3_month_log, na.rm = T),
      sd = sd(fatal_3_month_log, na.rm = T),
      mean = mean(fatal_3_month_log, na.rm = T)
    ) %>%
    #Calculate month year based on present month (minus 6 weeks)
    filter(month_yr == paste(month.abb[month(format(Sys.Date() - 45))], year(format(Sys.Date() - 45)))) 
  
  # Normalise scores
  acled <- normfuncpos(acled, 1, -1, "fatal_z")
  
  # Correct for countries with 0
  acled <- acled %>%
    mutate(
      fatal_z_norm = case_when(
        is.nan(fatal_z) ~ 0,
        TRUE ~ fatal_z_norm
      ),
      Country = countrycode(
        iso3,
        origin = "country.name",
        destination = "iso3c",
        nomatch = NULL
      ),
      fatal_z_norm = case_when(
        fatal_3_month_log == 0 ~ 0,
        (fatal_3_month_log <= log(5 + 1) & fatal_3_month_log != 0 ) & fatal_z <= 1 ~ 0,
        (fatal_3_month_log <= log(5 + 1) & fatal_3_month_log != 0 ) & fatal_z >= 1 ~ 5,
        TRUE ~ fatal_z_norm
      )
    ) %>%
    ungroup() %>%
    dplyr::select(-iso3)
  
  #--------------------------—REIGN--------------------------------------------
  # reign_data <- suppressMessages(read_csv("https://cdn.rawgit.com/OEFDataScience/REIGN.github.io/gh-pages/data_sets/REIGN_2021_5.csv", col_types = cols()))
  
  month <- as.numeric(format(Sys.Date(),"%m"))
  year <- as.numeric(format(Sys.Date(),"%Y"))
  
  l <- F
  i <- 0
  while(l == F & i < 20) {
    tryCatch(
      {
        reign_data <- suppressMessages(read_csv(paste0("https://cdn.rawgit.com/OEFDataScience/REIGN.github.io/gh-pages/data_sets/REIGN_", year, "_", month, ".csv"),
                                                col_types = cols()))
                                                # FIX: same error as acaps, but message supressed
        l <- T
        print(paste0("Found REIGN csv at ", year, "-", month))
      }, error = function(e) {
        print(paste0("No REIGN csv for ", year, "-", month))
      }, warning = function(w) {
      }, finally = {
      }
    )
    
    if(month > 1) {
      month <- month - 1
    } else {
      month <- 12
      year <- year - 1
    }
    i <- i + 1
  }
  
  reign_start <- reign_data %>%
    filter(year == max(year, na.rm= T)) %>%
    group_by(country) %>%
    slice(which.max(month)) %>%
    dplyr::select(country, month, pt_suc, pt_attempt, delayed, irreg_lead_ant, anticipation) %>%
    mutate(
      country = countrycode(country,
                            origin = "country.name",
                            destination = "iso3c",
                            nomatch = NULL
      )) %>%
    rename(Country = country)
  
  # Add FSI/BRD threshold
  reign <- left_join(reign_start, fcv %>% dplyr::select(Country, FCV_normalised), by = "Country") %>%
    mutate(
      irreg_lead_ant = case_when(
        FCV_normalised == 10 ~ irreg_lead_ant,
        TRUE ~ 0
      ),
      delayed_adj = case_when(
        FCV_normalised == 10 ~ delayed,
        TRUE ~ 0
      ),
      anticipation_adj = case_when(
        FCV_normalised == 10 ~ anticipation,
        TRUE ~ 0
      ),
      pol_trigger = case_when(
        pt_suc + pt_attempt + delayed_adj + irreg_lead_ant + anticipation_adj >= 1 ~ "Fragile",
        TRUE ~ "Not Fragile"
      ),
      pol_trigger_norm = case_when(
        pt_suc + pt_attempt + delayed_adj + irreg_lead_ant + anticipation_adj >= 1 ~ 10,
        TRUE ~ 0
      )
    ) %>%
    dplyr::select(-FCV_normalised)
  
  #-----------------—Join all dataset-----------------------------------
  conflict_dataset_raw <- left_join(fcv, reign, by = "Country") %>%
    left_join(., idp, by = "Country") %>%
    left_join(., acled, by = "Country") #%>%
  #dplyr::select(Countryname, FCV_normalised, pol_trigger_norm, z_idps_norm, fatal_z_norm) 
  
  conflict_dataset <- conflict_dataset_raw %>%
    # mutate(
    #   flag_count = as.numeric(unlist(row_count(
    #     .,
    #     pol_trigger_norm:fatal_z_norm,
    #     count = 10,
    #     append = F
    #   ))),
    #   fragile_1_flag = case_when(
    #     flag_count >= 1 ~ 10,
    #     TRUE ~ suppressWarnings(apply(conflict_dataset_raw %>% dplyr::select(pol_trigger_norm:fatal_z_norm), 
    #                  1,
  #                  FUN = max,
  #                  na.rm = T)
  #   )),
  #   fragile_1_flag = case_when(
  #     fragile_1_flag == -Inf ~ NA_real_,
  #     TRUE ~ fragile_1_flag
  #   )) %>%
  rename(FCS_Normalised = FCV_normalised, REIGN_Normalised = pol_trigger_norm,
         Displaced_UNHCR_Normalised = z_idps_norm, BRD_Normalised = fatal_z_norm#,
         # Number_of_High_Risk_Flags = flag_count, Overall_Conflict_Risk_Score = fragile_1_flag
  ) 
  
  #-------------------------------------—Create Fragility sheet--------------------------------------
  # Compile joint database
  countrylist <- read.csv(paste0(github, "Indicator_dataset/countrylist.csv"))
  
  fragility_sheet <- left_join(countrylist, conflict_dataset, by = "Country") %>%
    dplyr::select(-X) %>%
    # dplyr::select(-X, -Number_of_High_Risk_Flags) %>%
    rename_with(
      .fn = ~ paste0("Fr_", .), 
      .cols = colnames(.)[!colnames(.) %in% c("Country", "Countryname") ]
    )
  
  write.csv(fragility_sheet, "Risk_sheets/fragilitysheet.csv")

  lap <- Sys.time() - lapStart
  print(paste("Fragility sheet written", lap, units(lap)))
}